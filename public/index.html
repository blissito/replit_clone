<!DOCTYPE html>
<html>
<head>
  <title>Landing Maker - Fixed</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white h-screen flex">
  <!-- Chat -->
  <div class="w-1/3 border-r border-gray-700 flex flex-col">
    <div class="p-4 border-b border-gray-700">
      <div class="flex items-center justify-between mb-2">
        <h1 class="text-xl font-bold">Landing Maker</h1>
        <select id="model-selector" class="bg-gray-800 text-white text-sm border border-gray-600 rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="gpt-5-nano" selected>GPT-5 Nano</option>
          <option value="gpt-5-mini">GPT-5 Mini</option>
          <option value="claude-3-haiku-20240307">Haiku 3</option>
          <option value="claude-3-5-sonnet-20241022">Sonnet 4.5</option>
        </select>
      </div>
      <p class="text-xs text-gray-400">AI-powered landing page builder</p>
    </div>
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
    <form id="chat-form" class="p-4 border-t border-gray-700">
      <input id="input" type="text" placeholder="Describe tu landing page..." 
        class="w-full bg-gray-800 text-white px-4 py-2 rounded border border-gray-600">
    </form>
  </div>
  
  <!-- Preview -->
  <div class="flex-1 bg-white">
    <iframe id="preview" class="w-full h-full border-0"></iframe>
  </div>

  <script>
    let currentProjectId = null;
    let conversationHistory = [];
    const messages = document.getElementById('messages');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('input');
    const preview = document.getElementById('preview');
    const modelSelector = document.getElementById('model-selector');

    form.onsubmit = async (e) => {
      e.preventDefault();
      const msg = input.value.trim();
      if (!msg) return;

      // Add user message
      messages.innerHTML += `<div class="text-right"><div class="inline-block bg-blue-600 px-3 py-2 rounded">${msg}</div></div>`;
      input.value = '';

      // Show loading indicator
      const selectedModelName = modelSelector.options[modelSelector.selectedIndex].text;
      const loadingEl = document.createElement('div');
      loadingEl.className = 'flex items-center gap-2 p-3 bg-gray-800 rounded';
      loadingEl.innerHTML = `
        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
        <span class="text-sm text-gray-400 ml-2">${selectedModelName} est√° pensando...</span>
      `;
      messages.appendChild(loadingEl);
      messages.scrollTop = messages.scrollHeight;

      // Stream response
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          message: msg,
          conversationHistory,
          projectId: currentProjectId,
          model: modelSelector.value
        })
      });
      
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let assistantMsg = '';
      let firstEvent = true;

      const msgEl = document.createElement('div');
      msgEl.className = 'bg-gray-800 px-3 py-2 rounded';

      while (true) {
        const {done, value} = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            try {
              const event = JSON.parse(line.slice(6));
              console.log('Event:', event);

              // Remove loading on first event
              if (firstEvent) {
                loadingEl.remove();
                messages.appendChild(msgEl);
                firstEvent = false;
              }

              if (event.type === 'tool-start') {
                // Show tool execution card (Claude Code style)
                const toolNames = {
                  'create_html': 'Creando p√°gina HTML',
                  'edit_code': 'Editando c√≥digo',
                  'deploy_to_netlify': 'Desplegando a Netlify',
                  'get_code': 'Leyendo c√≥digo'
                };

                const toolCard = document.createElement('div');
                // CRITICAL FIX: Use unique ID based on toolCallId to avoid collisions
                const uniqueId = event.toolCallId || `tool-${event.tool}-${Date.now()}`;
                toolCard.id = uniqueId;
                toolCard.dataset.toolName = event.tool; // Store tool name for lookup
                toolCard.className = 'flex items-center gap-3 p-3 bg-blue-900/20 border border-blue-700 rounded mb-2';
                toolCard.innerHTML = `
                  <span class="text-2xl">${event.icon || 'üîß'}</span>
                  <div class="flex-1">
                    <div class="text-sm font-medium text-blue-200">${toolNames[event.tool] || event.tool}</div>
                    <div class="text-xs text-blue-400 mt-0.5">${event.message || 'Procesando...'}</div>
                  </div>
                  <div class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                `;
                messages.appendChild(toolCard);
                messages.scrollTop = messages.scrollHeight;
              }
              else if (event.type === 'tool-success') {
                console.log('‚úÖ tool-success event received:', event);
                // Update tool card to success - find by toolCallId
                const uniqueId = event.toolCallId || `tool-${event.tool}`;
                const toolCard = document.getElementById(uniqueId);
                console.log('Looking for card with id:', uniqueId, 'Found:', !!toolCard);
                if (toolCard) {
                  const toolNames = {
                    'create_html': 'P√°gina creada',
                    'edit_code': 'C√≥digo actualizado',
                    'deploy_to_netlify': 'Desplegado',
                    'get_code': 'C√≥digo obtenido'
                  };

                  const icons = {
                    'create_html': 'üé®',
                    'edit_code': '‚úèÔ∏è',
                    'deploy_to_netlify': 'üöÄ',
                    'get_code': 'üìñ'
                  };

                  toolCard.className = 'flex items-center gap-3 p-3 bg-green-900/20 border border-green-700 rounded mb-2';
                  toolCard.innerHTML = `
                    <span class="text-2xl">${icons[event.tool] || '‚úì'}</span>
                    <div class="flex-1">
                      <div class="text-sm font-medium text-green-200">${toolNames[event.tool] || 'Completado'}</div>
                      ${event.message ? `<div class="text-xs text-green-400 mt-0.5">${event.message}</div>` : ''}
                      ${event.files && event.files.length > 0 ? `<div class="text-xs text-green-400 mt-0.5">üìÑ ${event.files.join(', ')}</div>` : ''}
                    </div>
                    <span class="text-green-400 text-lg">‚úì</span>
                  `;
                  console.log('‚úÖ Card updated successfully');
                } else {
                  console.warn('‚ö†Ô∏è Tool card not found for:', event.tool);
                }
              }
              else if (event.type === 'chunk') {
                assistantMsg += event.content;
                msgEl.textContent = assistantMsg;
              }
              else if (event.type === 'code-updated') {
                currentProjectId = event.projectId;
                // Add timestamp to force iframe reload
                preview.src = `/api/preview/${event.projectId}?t=${Date.now()}`;
                console.log('Preview updated:', event.projectId);
              }
              else if (event.type === 'done') {
                // Save to conversation history
                conversationHistory.push({role: 'user', content: msg});
                conversationHistory.push({role: 'assistant', content: assistantMsg});
                console.log('üí≠ History:', conversationHistory.length, 'messages');
              }
            } catch {}
          }
        }
      }

      messages.scrollTop = messages.scrollHeight;
    };
  </script>
</body>
</html>
